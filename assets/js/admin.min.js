jQuery(document).ready(function($){
    // ----------------------------------------------------
    // Common
    // ----------------------------------------------------
    $(document).ajaxStart(function(){
        $("button").attr("disabled","true");
    });
    $(document).ajaxStop(function(){
        $("button").removeAttr("disabled");
    });
    if (navigator.userAgent.match(/msie [6|7]/i)) {
        $("div.navbar:first").after('<div class="alert text-center"><strong>注意: </strong>为了获得更好的使用体验，请使用<a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" target="_blank">IE8及其以上版本</a>，最佳体验使用IE9，<a href="http://www.google.com/chrome/" target="_blank">谷歌</a>，<a href="http://firefox.com.cn/" target="_blank">火狐</a>等浏览器。</div>');
    }
    (function () {
        var $backToTopEle = jQuery('<div class="backtop"><a href="javascript:;"></a></div>').appendTo(jQuery("body"));

        jQuery('.backtop').click(function () {
            jQuery("html, body").animate({ scrollTop: 0 }, 200);
        });

        var _w = (jQuery(window).width() - 980) / 2 - 30;

        $backToTopFun = function () {
            var st = jQuery(document).scrollTop(),
            winh = jQuery(window).height();
            $backToTopEle.css("right", _w);
            (st > 100) ? $backToTopEle.fadeIn() : $backToTopEle.fadeOut();
            // For IE6
            if (!window.XMLHttpRequest) {
                $backToTopEle.css("top", st + winh - 100);
            }
        };
        jQuery(window).bind("scroll", $backToTopFun);
        $backToTopFun();
    })();

    $("div.block label.tip").click(function (){
        $(this).hide();
        $(this).prev().focus();
    });
    $("div.block input").focus(function () {
        $(this).next().hide();
    }).blur(function () {
        if ($(this).val() == "") $(this).next().show();
    }).show(function() {
        if ($(this).val() != "") $(this).next().hide();
    });
    $("div.block textarea").focus(function () {
        $(this).next().hide();
    }).blur(function () {
        if ($(this).val() == "") $(this).next().show();
    }).show(function() {
        if ($(this).val() != "") $(this).next().hide();
    });

    $fmt = function(num) {
        if (num) {
            if (num.length > 4) {
                return num.substr(0, num.length-4) + '万' + num.substr(-4);
            }
        }
        return num;
    }
    $("input.money").focus(function(){
        $(this).css({imeMode:'disabled'});
        if ($(this).val()) {
            var top = $(this).position().top - 35;
            var left = $(this).position().left;
            $(".money-preview").removeClass("hide").html($fmt($(this).val())).css({top: top, left: left});
        }
    }).keypress(function(e){
        if ((e.keyCode > 47) && (e.keyCode < 58)) {
            return true;
        }
        return false;
    }).keyup(function(){
        var $p = $(this).val().replace(/[^\d]*/g, '');
        
        if ($p) {
            var top = $(this).position().top - 35;
            var left = $(this).position().left;
            $(".money-preview").removeClass("hide").html($fmt($p)).css({top: top, left: left});
        } else {
            $(".money-preview").addClass("hide").html($p);
        }
    }).blur(function(){
        $(".money-preview").addClass("hide");
    });
    $("div.datepick").each(function(){
        $(this).datetimepicker({
            language:  'zh-CN',
            format: $("input", $(this)).attr("data-date-format") || "yyyy-mm-dd hh:ii",
            autoclose: true,
            todayBtn: true,
            minView: ($("input", $(this)).attr("data-date-format"))? 2: 0,
            pickerPosition: "bottom-left"
        });
    });

    $('#myTab a').click(function (e) {
        e.preventDefault();
        $(this).tab('show');
    });

    // File upload
    // ----------------------------------------------------
    function delimage($this) {
        var $id = $("input[type='hidden'][name='id']:first").attr("value");
        var $base = $("input[type='hidden'][name='base']:first").attr("value");
        var $control = $("input[type='hidden'][name='control']:first").attr("value");
        var $thumb = $("input[type='hidden'][name='base-thumb']:first").attr("value");
        var $name = $("img", $this.parent()).attr("src").replace($thumb, "");
        var $label = $('#albums span.label');
        var $that = $this;
        $.post($base + "/admin/" + $control + "/delimage/" + $id, {name: $name}, function(out){
            if (out.status == 0) {
                $that.parent().hide("slow", function(){
                    $(this).remove();
                });
                $label.addClass("label-success").removeClass("label-important");
            } else {
                $label.addClass("label-important").remvoeClass("label-success");
            }
            $label.text(out.msg);
            setTimeout(function(){$label.text("");}, 2000);
        }, "json");
    }
    $("#myModal.upload").on("show", function() {
        var $id = $("input[type='hidden'][name='id']:first").attr("value");
        var $base = $("input[type='hidden'][name='base']:first").attr("value");
        var $control = $("input[type='hidden'][name='control']:first").attr("value");
        var $thumb = $("input[type='hidden'][name='base-thumb']:first").attr("value");
        var $process = $('div.progress');
        var $bar = $('div.progress .bar', $(this));
        var $label = $('span.label', $(this));
        $label.text("");
        $bar.css({width: '0%'});

        $('#upload').fileupload({
            url : $base + "/admin/" + $control + "/upload/" + $id,
            dataType: 'json',
            autoUpload: true,
            acceptFileTypes: /(\.|\/)(gif|jpe?g|png)$/i,
            maxNumberOfFiles: 1,
            fileInput: $(this),
            maxFileSize: 5000,
            previewMaxWidth : 200,
            previewMaxHeight : 200,
            add: function(e, data) {
                data.submit();
                $process.addClass('progress-success').removeClass('progress-danger');
            },
            formData: {},
            progressall: function (e, data) {
                var percent = parseInt(data.loaded / data.total * 100, 10);
                $bar.css('width', percent + '%');
            },
            done: function (e, data) {
                if (data.textStatus != "success" || data.result.status != 0){
                    $process.addClass('progress-danger').removeClass('progress-success');
                    data.result.msg && $label.text(data.result.msg).addClass("label-important").removeClass("label-success");
                } else {
                    var $albums = $("#albums .thumbnails");
                    var $li = $("<li />").addClass("span2");
                    var $span = $('<span class="icon-remove pull-right del"></span>').appendTo($li);
                    $("<img />").attr("src", $thumb + data.result.name).appendTo($li);

                    $li.appendTo($albums);
                    $span.click(function(){
                        delimage($(this));
                        return false;
                    });
                    $
                    data.result.msg && $label.text(data.result.msg).addClass("label-success").removeClass("label-important");
                    setTimeout(function(){$("#myModal.upload").modal("hide");}, 1000);
                }
            }
        });
    }).on("hidden", function(){
        $('#upload').fileupload('destroy');
    });
    $("#albums span.del").click(function(){
        delimage($(this));
        return false;
    });

    // ----------------------------------------------------
    // User
    // ----------------------------------------------------
    $("#user form").submit(function(){
        $("button").attr("disabled","true");
        // Validate
        // Submit
        var $base = $("input[type='hidden'][name='base']:first").attr("value");
        var id = $("input[type='hidden'][name='id']").val();
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                if (!id) {
                    setTimeout(function(){location.href = $base + "/admin/user/edit/" + data.id;}, 1000);
                }
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                //$("#msg").alert("close");
            }
            $("button").removeAttr("disabled");
        }, "json");
        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });
    $("#user #myModal button[name='complete']").click(function(){
        $("button").attr("disabled","true");
        var $base = $("input[type='hidden'][name='base']:first").attr("value");
        var id = $("input[type='hidden'][name='id']").val();
        var p = $.trim($("input[name='pwd']").val());
        $.post($base + "/admin/user/pwd", {id: id, p: p}, function(data){
            if (data.status == 0) {
                $("#modal-msg").attr("class","alert fade in");
                $("#modal-msg").text(data.msg);
                $("#modal-msg").alert();
                setTimeout(function(){
                    $("#modal-msg").addClass('hide');
                    $("input[name='pwd']").val("");
                }, 2000);
            } else {
                $("#modal-msg").attr("class","alert alert-block alert-error fade in");
                $("#modal-msg").text(data.msg);
                $("#modal-msg").alert();
            }
            $("button").removeAttr("disabled");
        }, "json");
    });
    $("#user #delete-modal button[name='delete']").click(function(){
        $("button").attr("disabled","true");
        var $base = $("input[type='hidden'][name='base']:first").attr("value");
        var id = $("input[type='hidden'][name='id']").val();
        $.post($base + "/admin/user/delete", {id: id}, function(data){
            if (data.status == 0) {
                $("#delete-modal-msg").attr("class","alert fade in");
                $("#delete-modal-msg").text(data.msg);
                $("#delete-modal-msg").alert();
                setTimeout(function(){location.href = $base + "/admin/user/";}, 1000);
            } else {
                $("#delete-modal-msg").attr("class","alert alert-block alert-error fade in");
                $("#delete-modal-msg").text(data.msg);
                $("#delete-modal-msg").alert();
            }
            $("button").removeAttr("disabled");
        }, "json");
    });

    // ----------------------------------------------------
    // Prebook
    // ----------------------------------------------------
    $("#prebook input[name='chk-username']").click(function(){
        if ($(this).is(":checked")) {
            $("#prebook input[name='username']").attr("readonly", "true").addClass(" uneditable-input");
            $("#prebook input[name='email']").attr("readonly", "true").addClass(" uneditable-input");
        } else {
            $("#prebook input[name='username']").removeAttr("readonly").removeClass(" uneditable-input");
            $("#prebook input[name='email']").removeAttr("readonly").removeClass(" uneditable-input");
        }
    });

    $("#prebook form button[name='invalid']").click(function(){
        $("#prebook form").append('<input type="hidden" name="status" value="invalid" />');
        $("#prebook form").trigger("submit");
        $("#prebook form input[name='status'][type='hidden']").remove();
        return false;
    });
    $("#prebook form").submit(function(){
        $("button").attr("disabled","true");
        // Submit
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                location.href = $base + "/admin/prebook/";
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                //$("#msg").alert("close");
            }
        }, "json");
        $("button").removeAttr("disabled");

        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });
    $('#prebook-list button.delete').click(function(){
        if (confirm('确定删除吗?')) {
            $("button").attr("disabled","true");
            var $base = $("input[type='hidden'][name='base']:first").attr("value");
            var id = $(this).attr('data-id');
            var $that = $(this);
            $.post($base + '/admin/prebook/del/' + id, function(data){
                if (data.status == 0) {
                    $("#msg").attr("class","label alert fade in");
                    $("#msg").text(data.msg);
                    $("#msg").alert();
                    $that.parent().parent().remove();
                } else {
                    $("#msg").attr("class","label alert alert-block alert-error fade in");
                    $("#msg").text(data.msg);
                    $("#msg").alert();
                }
            }, 'json')
        }
    });

    // ----------------------------------------------------
    // Test page
    // ----------------------------------------------------
    $("#test select[name='color']").simplecolorpicker({picker: true});
    $("#test input.score").keypress(function(e){
        if ((e.keyCode > 47) && (e.keyCode < 58)) {
            return true;
        }
        return false;
    }).keyup(function(){
        var $p = $(this).val().replace(/[^\d]*/g, '');
        
        var s = 0;
        if ($p) {
            $("input.score").each(function(){
                s += parseInt($(this).val());
            });
            $("#test #inputConditionScore").val(s);
        }
    }).blur(function(){
        var s = 0;
        $("input.score").each(function(){
            s += parseInt($(this).val());
        });
        if (!isNaN(s)) {
            if ($('#test #inputIssueCar').val() == 'yes') {
                s += ' 五级';
            } else if ($('#test #inputIssueCar').val() == 'no'){
                if (s >= 90) {
                    s += ' 一级';
                } else if (s >= 60 && s < 90) {
                    s += ' 二级';
                } else if (s >= 20 && s < 60) {
                    s += ' 三级';
                } else if (s <= 20) {
                    s += ' 四级';
                }
            }
        }
        $("#test #inputConditionScore").val(s);
    });
    $('#test #inputIssueCar').change(function(){
        $("#test input.score:last").trigger('blur');
    });
    $("#test input.score:last").trigger('blur');

    $("#test form button[name='complete']").click(function(){
        $("#test form").append('<input type="hidden" name="status" value="finish" />');
        $("#test form").trigger("submit", true);
        $("#test form input[name='status'][type='hidden']").remove();
        return false;
    });
    $("#test form").submit(function(event, $test){
        $("button").attr("disabled","true");
        var $id = $("input[type='hidden'][name='id']:first").attr("value");
        var $base = $("input[type='hidden'][name='base']:first").attr("value");
        // Submit
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                if ($test) {
                    location.href = $base + "/admin/test/edit/" + ($id+1);
                }
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
            }
            $("html, body").animate({scrollTop: 0}, 200);
        }, "json");
        $("button").removeAttr("disabled");

        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });
    $('#test-list button.delete').click(function(){
        if (confirm('确定删除吗?')) {
            $("button").attr("disabled","true");
            var $base = $("input[type='hidden'][name='base']:first").attr("value");
            var id = $(this).attr('data-id');
            var $that = $(this);
            $.post($base + '/admin/test/del/' + id, function(data){
                if (data.status == 0) {
                    $("#msg").attr("class","label alert fade in");
                    $("#msg").text(data.msg);
                    $("#msg").alert();
                    $that.parent().parent().remove();
                } else {
                    $("#msg").attr("class","label alert alert-block alert-error fade in");
                    $("#msg").text(data.msg);
                    $("#msg").alert();
                }
            }, 'json')
        }
    });

    // ----------------------------------------------------
    // Auction
    // ----------------------------------------------------
    $("#auction #myModal").on("show", function() {
        $("#auction form").append('<input type="hidden" name="status" value="finish" />');
    }).on("hidden", function(){
        $("#auction form input[name='status'][type='hidden']").remove();
    });
    $("#auction form").submit(function(){
        $("button").attr("disabled","true");
        var $id = $("input[type='hidden'][name='id']:first").attr("value");
        var $base = $("input[type='hidden'][name='base']:first").attr("value");
        // Submit
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if ($("#auction input[name='status']").length > 0) {
                $msg = $("#modal-msg");
            } else {
                $msg = $("#msg");
            }
            if (data.status == 0) {
                $msg.attr("class","alert fade in");
                $msg.text(data.msg);
                $msg.alert();
                setTimeout(function(){
                    location.href = $base + "/admin/auction/";
                }, 2000);
            } else {
                $msg.attr("class","alert alert-block alert-error fade in");
                $msg.text(data.msg);
                $msg.alert();
            }
            $("html, body").animate({scrollTop: 0}, 200);
        }, "json");
        $("button").removeAttr("disabled");

        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });
    $('#auction-list button.delete').click(function(){
        if (confirm('确定删除吗?')) {
            $("button").attr("disabled","true");
            var $base = $("input[type='hidden'][name='base']:first").attr("value");
            var id = $(this).attr('data-id');
            var $that = $(this);
            $.post($base + '/admin/auction/del/' + id, function(data){
                if (data.status == 0) {
                    $("#msg").attr("class","label alert fade in");
                    $("#msg").text(data.msg);
                    $("#msg").alert();
                    $that.parent().parent().remove();
                } else {
                    $("#msg").attr("class","label alert alert-block alert-error fade in");
                    $("#msg").text(data.msg);
                    $("#msg").alert();
                }
            }, 'json')
        }
    });

    // ----------------------------------------------------
    // Article
    // ----------------------------------------------------
    var $base = $("#article input[name='base'][type='hidden']").attr("value");
    if ($("#inputContent").length > 0) {
        CKEDITOR && CKEDITOR.replace("inputContent", {
            height: 300,
            language: 'zh-cn',
            filebrowserBrowseUrl:      $base + 'assets/editor/ckfinder/ckfinder.html',
            filebrowserImageBrowseUrl: $base + 'assets/editor/ckfinder/ckfinder.html?Type=Images',
            filebrowserFlashBrowseUrl: $base + 'assets/editor/ckfinder/ckfinder.html?Type=Flash',
            filebrowserUploadUrl:      $base + 'assets/editor/ckfinder/core/connector/php/connector.php?command=QuickUpload&type=Files',
            filebrowserImageUploadUrl: $base + 'assets/editor/ckfinder/core/connector/php/connector.php?command=QuickUpload&type=Images',
            filebrowserFlashUploadUrl: $base + 'assets/editor/ckfinder/core/connector/php/connector.php?command=QuickUpload&type=Flash'
        });
    }
    $("#article form").submit(function(){
        $("button").attr("disabled","true");
        // Get editor data
        $("#inputContent").val(CKEDITOR.instances.inputContent.getData());
        // Submit
        var id = $("input[type='hidden'][name='id']").val();
        var $base_article = $("input[type='hidden'][name='base-article']:first").attr("value");
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            $msg = $("#msg");
            if (data.status == 0) {
                $msg.attr("class","alert fade in");
                $msg.text(data.msg);
                $msg.alert();
                if (!id) {
                    setTimeout(function(){location.href = $base_article + "/admin/article/edit/" + data.id;}, 1000);
                }
            } else {
                $msg.attr("class","alert alert-block alert-error fade in");
                $msg.text(data.msg);
                $msg.alert();
            }
            $("html, body").animate({scrollTop: 0}, 200);
            $("button").removeAttr("disabled");
        }, "json");

        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });

    // ----------------------------------------------------
    // Deal
    // ----------------------------------------------------
    function dealuser($this) {
        $("#deal table.select-user tbody input[type='checkbox']").each(function(){
            if ($this.val() == $(this).val()) {
                if ($this.is(":checked")) {
                    $("input[name='sale_to']").val($this.val());
                    $("span#sale-to").html($this.attr("data-u"));
                    if ($this.attr("data-p")) {
                        $("input[name='final_price']").val($this.attr("data-p"));
                    } else {
                        $("input[name='final_price']").val("");
                    }
                } else {
                    $("input[name='sale_to']").val("");
                    $("span#sale-to").html("");
                    $("input[name='final_price']").val("");
                }
            } else {
                $(this).attr("checked", false);
            }
        });
    }
    $("#deal div.search-user button").click(function(){
        var $base = $("input[type='hidden'][name='base']:first").attr("value");
        var k = $("#deal div.search-user input[name='username']").val();
        if (k !== '') {
            var $t = $("#deal table.select-user tbody");
            $.post($base + '/admin/deal/moreuser/', {k: k}, function(data){
                $msg = $("#modal-msg");
                if (data.status == 0) {
                    var $max = 0;
                    var isadd = true;
                    $("tr", $t).each(function(){
                        if ($("td input[type='checkbox']", $(this)).val() == data.user.id) {
                            isadd = false;
                        }
                        var tmp = parseInt($("td:eq(1)", $(this)).html().replace('#', ''));
                        if (tmp > $max) {
                            $max = tmp;
                        }
                    });
                    if (isadd) {
                        $add = $('<tr><td><input type="checkbox" name="cbox" value="'+data.user.id+'" data-u="'+data.user.username+'"></td><td>#'+ ($max+1) +'</td><td>'+data.user.username+'</td><td>--</td></tr>');
                        $add.appendTo($t);
                        $("input[type='checkbox']", $add).click(function(){
                            dealuser($(this));
                        });
                        $msg.attr("class","alert fade in");
                        $msg.text(data.msg);
                        $msg.alert();
                    }
                } else {
                    $msg.attr("class","alert alert-block alert-error fade in");
                    $msg.text(data.msg);
                    $msg.alert();
                }
            }, "json");
        }
    });
    $("#deal table.select-user tbody input[type='checkbox']").click(function(){
        dealuser($(this));
    });

    $("#deal #myModal").on("show", function() {
        $("#deal form").append('<input type="hidden" name="status" value="finish" />');
    }).on("hidden", function(){
        $("#deal form input[name='status'][type='hidden']").remove();
    });
    $("#deal form").submit(function(){
        $("button").attr("disabled","true");
        // Submit
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            $msg = $("#modal-msg");
            if (data.status == 0) {
                $msg.attr("class","alert fade in");
                $msg.text(data.msg);
                $msg.alert();
                location.href = $base + "/admin/deal/";
            } else {
                $msg.attr("class","alert alert-block alert-error fade in");
                $msg.text(data.msg);
                $msg.alert();
                //$("#msg").alert("close");
            }
        }, "json");
        $("button").removeAttr("disabled");

        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });

    $("#re-auction button[name='ok']").click(function(){
        $("button").attr("disabled","true");
        var $id = $("input[type='hidden'][name='id']:first").attr("value");
        var $base = $("input[type='hidden'][name='base']:first").attr("value");
        var $start = $("#re-auction input[name='sale_start_date']").val();
        var $end = $("#re-auction input[name='sale_end_date']").val();
        // Submit
        $.post($base + '/admin/deal/reauction/' + $id, {'sale_start_date': $start, 'sale_end_date': $end}, function(data){
            $msg = $('#re-auction div.modal-msg');
            if (data.status == 0) {
                $msg.attr("class","alert fade in");
                $msg.text(data.msg);
                $msg.alert();
                setTimeout(function(){
                    location.href = $base + "/admin/deal/edit/" + $id;
                }, 2000);
            } else {
                $msg.attr("class","alert alert-block alert-error fade in");
                $msg.text(data.msg);
                $msg.alert();
            }
            $("html, body").animate({scrollTop: 0}, 200);
        }, "json");
        $("button").removeAttr("disabled");

        return false;
    });

    $("#a2c button[name='ok']").click(function(){
        $("button").attr("disabled","true");
        var $id = $("input[type='hidden'][name='id']:first").attr("value");
        var $base = $("input[type='hidden'][name='base']:first").attr("value");
        var $start = $("#a2c input[name='sale_start_date']").val();
        var $end = $("#a2c input[name='sale_end_date']").val();
        // Submit
        $.post($base + '/admin/deal/a2c/' + $id, {'sale_start_date': $start, 'sale_end_date': $end}, function(data){
            $msg = $('#a2c div.modal-msg');
            if (data.status == 0) {
                $msg.attr("class","alert fade in");
                $msg.text(data.msg);
                $msg.alert();
                setTimeout(function(){
                    location.href = $base + "/admin/deal/edit/" + $id;
                }, 2000);
            } else {
                $msg.attr("class","alert alert-block alert-error fade in");
                $msg.text(data.msg);
                $msg.alert();
            }
            $("html, body").animate({scrollTop: 0}, 200);
        }, "json");
        $("button").removeAttr("disabled");

        return false;
    });

    $('#deal-list button.delete').click(function(){
        if (confirm('确定删除吗?')) {
            $("button").attr("disabled","true");
            var $base = $("input[type='hidden'][name='base']:first").attr("value");
            var id = $(this).attr('data-id');
            var $that = $(this);
            $.post($base + '/admin/deal/del/' + id, function(data){
                if (data.status == 0) {
                    $("#msg").attr("class","label alert fade in");
                    $("#msg").text(data.msg);
                    $("#msg").alert();
                    $that.parent().parent().remove();
                } else {
                    $("#msg").attr("class","label alert alert-block alert-error fade in");
                    $("#msg").text(data.msg);
                    $("#msg").alert();
                }
            }, 'json')
        }
    });
    // ----------------------------------------------------
    // Car
    // ----------------------------------------------------
    $("#car select[name='color']").simplecolorpicker({picker: true});
    $("#car input.score").keypress(function(e){
        if ((e.keyCode > 47) && (e.keyCode < 58)) {
            return true;
        }
        return false;
    }).keyup(function(){
        var $p = $(this).val().replace(/[^\d]*/g, '');
        
        var s = 0;
        if ($p) {
            $("input.score").each(function(){
                s += parseInt($(this).val());
            });
            $("#car #inputConditionScore").val(s);
        }
    }).blur(function(){
        var s = 0;
        $("input.score").each(function(){
            s += parseInt($(this).val());
        });
        $("#car #inputConditionScore").val(s);
    });

    $("#car form").submit(function(){
        $("button").attr("disabled","true");
        var $id = $("input[type='hidden'][name='id']:first").attr("value");
        var $base = $("input[type='hidden'][name='base']:first").attr("value");
        // Submit
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
            }
            $("html, body").animate({scrollTop: 0}, 200);
        }, "json");
        $("button").removeAttr("disabled");

        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });

    $('#car-list button.delete').click(function(){
        if (confirm('确定删除吗?')) {
            $("button").attr("disabled","true");
            var $base = $("input[type='hidden'][name='base']:first").attr("value");
            var id = $(this).attr('data-id');
            var $that = $(this);
            $.post($base + '/admin/car/del/' + id, function(data){
                if (data.status == 0) {
                    $("#msg").attr("class","label alert fade in");
                    $("#msg").text(data.msg);
                    $("#msg").alert();
                    $that.parent().parent().remove();
                } else {
                    $("#msg").attr("class","label alert alert-block alert-error fade in");
                    $("#msg").text(data.msg);
                    $("#msg").alert();
                }
            }, 'json')
        }
    });

});
