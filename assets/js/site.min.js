jQuery(document).ready(function($){
    /* Common setting
    --------------------------------*/
    $(document).ajaxStart(function(){
        $("button").attr("disabled","true");
    });
    $(document).ajaxStop(function(){
        $("button").removeAttr("disabled");
    });
    if (navigator.userAgent.match(/msie [6]/i)) {
        $("#logo").before('<div class="alert text-center"><strong>注意: </strong>为了获得更好的使用体验，请使用<a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" target="_blank">IE7, IE7, IE8, IE9, IE10</a>，最佳体验使用IE9，<a href="http://www.google.com/chrome/" target="_blank">谷歌</a>，<a href="http://firefox.com.cn/" target="_blank">火狐</a>等浏览器。</div>');
    }

    var $base = $("#baseurl").val();
    (function () {
        var $backToTopEle = jQuery('<div class="backtop"><a href="javascript:;" title="返回页面顶部"></a></div>').appendTo(jQuery("body"));

        jQuery('.backtop').click(function () {
            jQuery("html, body").animate({ scrollTop: 0 }, 200);
        });

        var _w = (jQuery(window).width() - 980) / 2 - 140;

        $backToTopFun = function () {
            var st = jQuery(document).scrollTop(),
            winh = jQuery(window).height();
            $backToTopEle.css("right", _w);
            (st > 100) ? $backToTopEle.fadeIn() : $backToTopEle.fadeOut();
            // For IE6
            if (!window.XMLHttpRequest) {
                $backToTopEle.css("top", st + winh - 100);
            }
        };
        jQuery(window).bind("scroll", $backToTopFun);
        $backToTopFun();
    })();
    $("div.block label.tip").click(function (){
        $(this).hide();
        $(this).prev().focus();
    });
    $("div.block input").focus(function () {
        $(this).next().hide();
    }).blur(function () {
        if ($(this).val() == "") $(this).next().show();
    });

    // Multi del
    $('[name="checkall"]').click(function(){
        if ($(this).is(':checked')) {
            $('[name="check"]').each(function(){
                $(this)[0].checked = true;
            });
        } else {
            $('[name="check"]').each(function(){
                $(this)[0].checked = false;
            });
        }
    });
    $('[name="multi-del"]').click(function(){
        var ids = [];
        $('[name="check"]').each(function(){
            if ($(this).is(':checked')) {
                ids.push($(this).val());
            }
        });

        if (ids.length > 0) {
            if (confirm('确定要删除吗?')) {
                $.post($(this).attr('href'), {ids: ids}, function(data) {
                    if (data.status == 0) {
                        $('[name="check"]').each(function(){
                            if ($.inArray($(this).val(), ids) != -1) {
                                $(this).parent().parent().remove();
                            }
                        });
                    }
                    // Message
                    data.msg && alert(data.msg);
                });
            }
        }
        return false;
    });

    /* Login
    --------------------------------*/
    $("#login #p-captcha>*").click(function(){
        var src = $("#login #image-captcha").attr("src").split("?")[0];
        $("#login #image-captcha").attr("src", src + "?n=" + (new Date().valueOf()));
    });
    $("#login form").submit(function(){
        $("button").attr("disabled","true");
        $.post($base + "/login/validate/", $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                //location.replace(data.url ? data.url : url);
                location.href = data.url || $base;
            } else {
                $("#login #p-captcha>img").trigger("click");
                $("#login input[name='captcha']").val("");
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                // Load capacha
                if ($('#login #p-captcha').length == 0) {
                    $('#login form input[name="pwd"]').parent().after('<p class="help-block" id="p-captcha">'+
                            '<img src="'+ $base +'captcha/?t='+ (new Date()).toString() +'" id="image-captcha"/><span class="btn btn-link" id="span-captcha" >看不清，换一张</span>'+
                        '</p>'+
                        '<div class="block">'+
                            '<input type="text" class="input-block-level" name="captcha" autocomplete="off">'+
                            '<label class="tip">验证码</label>'+
                        '</div>');

                    $("#login div.block label.tip").click(function (){
                        $(this).hide();
                        $(this).prev().focus();
                    });
                    $("#login div.block input").focus(function () {
                        $(this).next().hide();
                    }).blur(function () {
                        if ($(this).val() == "") $(this).next().show();
                    });
                    $("#login #p-captcha>*").click(function(){
                        var src = $("#login #image-captcha").attr("src").split("?")[0];
                        $("#login #image-captcha").attr("src", src + "?n=" + (new Date().valueOf()));
                    });

                }
            }
            $("button").removeAttr("disabled");
        }, "json");

        return false;
    });

    $(document).ajaxStart(function(){
        if ($('#ajax-message').length == 0) {
            $('<div id="ajax-message">Loading...</div>').css({
                position:'fixed', 
                top:10, 
                right:120, 
                width:120, 
                'z-index':2000, 
                'font-weight':'blod',
                color:'#de568d'
            }).appendTo($('body'));
        }
        $('#ajax-message').show();
    });
    $(document).ajaxStop(function(){
        $('#ajax-message').hide(800);
    });
    $(document).ajaxError();

    /* Home
    --------------------------------*/
    $("#home-edit form").submit(function(){
        $that = $(this);
        $("button").attr("disabled","true");
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
                setTimeout(function(){location.href = $base + "home";}, 1000);
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
            }
            $("html, body").animate({scrollTop: 0}, 200);
            $("button").removeAttr("disabled");
        }, "json");

        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });

    $("#home-index").find('button[name="add"]').click(function(){
        location.href = $base + 'home/edit';
    });
    $("#home-index").find('button[name="edit"]').click(function(){
        var c = $('#home-index').find('select[name="company"]');
        if (!c.val()) {
           alert('请选择公司'); 
           return false;
        }
        location.href = $base + 'home/edit/' + c.val();
    });
    $("#home-index").find('button[name="entry"]').click(function(){
        var c = $('#home-index').find('select[name="company"]');
        if (!c.val()) {
           alert('请选择公司'); 
           return false;
        }
        location.href = $base + 'home/entry/' + c.val();
    });
    $("#home-index").find('button[name="del"]').click(function(){
        var c = $('#home-index').find('select[name="company"]');
        if (!c.val()) {
           alert('请选择公司'); 
           return false;
        }
        if (confirm('确定要删除该公司?')) {
            $.post($base + 'home/del/' + c.val(), function(data){
                if (data.status == 0) {
                    $("#msg").attr("class","alert fade in");
                    $("#msg").html(data.msg);
                    $("#msg").alert();
                    setTimeout(function(){location.href = $base + "home";}, 1000);
                } else {
                    $("#msg").attr("class","alert alert-block alert-error fade in");
                    $("#msg").html(data.msg);
                    $("#msg").alert();
                }
                $("button").removeAttr("disabled");
            }, "json");
        }
    });

    /* User
    -----------------------------------------*/
    $("#user-edit form").submit(function(){
        $("button").attr("disabled","true");

        var id = $("input[type='hidden'][name='id']").val();
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
                if (!id) {
                    setTimeout(function(){location.href = $base + "user/edit/" + data.id;}, 1000);
                }
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
            }
            $("html, body").animate({scrollTop: 0}, 200);
            $("button").removeAttr("disabled");
        }, "json");
        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });

    $('#user-edit').find('#reset-pwd-modal').on('show', function(){
        $('input[name="login-pwd"]').val('');
        $('input[name="login-pwd2"]').val('');
        $("#modal-msg").removeClass('alert').html("");
    });
    $("#user-edit").find('button[name="reset-pwd"]').click(function(){
        var id = $("input[type='hidden'][name='id']").val();
        var pwd = $.trim($('input[name="login-pwd"]').val());
        var pwd2 = $.trim($('input[name="login-pwd2"]').val());
        if (pwd.length == 0 || pwd2.length == 0) {
            $("#modal-msg").addClass("alert fade in");
            $("#modal-msg").html('请输入密码');
            $("#modal-msg").alert();
            return false;
        }

        if (pwd != pwd2) {
            $("#modal-msg").addClass("alert fade in");
            $("#modal-msg").html('密码不一致');
            $("#modal-msg").alert();
            return false;
        }

        $("button").attr("disabled","true");
        $("#modal-msg").removeClass('alert').html("");
        $.post($base + 'user/reset', {id: id, pwd: pwd}, function(data){
            if (data.status == 0) {
                $("#modal-msg").attr("class","alert fade in");
                $("#modal-msg").html(data.msg);
                $("#modal-msg").alert();
                setTimeout(function(){$('#reset-pwd-modal').modal('hide');}, 2000);
            } else {
                $("#modal-msg").attr("class","alert alert-block alert-error fade in");
                $("#modal-msg").html(data.msg);
                $("#modal-msg").alert();
            }
            $("button").removeAttr("disabled");
        }, "json");
    });

    /* Store
    -----------------------------------------*/
    $("#store-edit form").submit(function(){
        $("button").attr("disabled","true");

        var id = $("input[type='hidden'][name='id']").val();
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
                if (!id) {
                    setTimeout(function(){location.href = $base + "store/edit/" + data.id;}, 1000);
                }
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
            }
            $("html, body").animate({scrollTop: 0}, 200);
            $("button").removeAttr("disabled");
        }, "json");
        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });

    /* Device
    -----------------------------------------*/
    $("#device-edit form").submit(function(){
        $("button").attr("disabled","true");

        var id = $("input[type='hidden'][name='id']").val();
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
                if (!id) {
                    setTimeout(function(){location.href = $base + "device/edit/" + data.id;}, 1000);
                }
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
            }
            $("html, body").animate({scrollTop: 0}, 200);
            $("button").removeAttr("disabled");
        }, "json");
        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });

    /* First
    -----------------------------------------*/
    $("#first-edit form").submit(function(){
        $("button").attr("disabled","true");

        var id = $("input[type='hidden'][name='id']").val();
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
                if (!id) {
                    setTimeout(function(){location.href = $base + "first/edit/" + data.id;}, 1000);
                }
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
            }
            $("html, body").animate({scrollTop: 0}, 200);
            $("button").removeAttr("disabled");
        }, "json");
        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });
    // Modal store
    $('#first-index-content .edit-store').click(function(){
        var id = $(this).attr('data-id');
        $.get($base + 'first/store/' + id, function(data){
            if (data.status == 0) {
                $('#first-modal-store [name="store-oid"]').each(function(){
                    if (_.indexOf(data.data, $(this).val()) != -1) {
                        $(this).attr('checked', true);
                    } else {
                        $(this).removeAttr('checked');
                    }
                });
                $('#first-modal-store [name="id"]').val(id);
                $('#first-modal-store').modal({'backdrop': 'static', 'show': true});
            }
        }, 'json');
        return false;
    });
    $('#first-modal-store .save').click(function(){
        var id = $('#first-modal-store [name="id"]').val();
        var store = [];
        $('#first-modal-store [name="store-oid"]').each(function(){
            if ($(this).is(':checked')) {
                store.push($(this).val());
            }
        });
        $.post($base + 'first/savestore/', {id: id, store: store}, function(data) {
            alert(data.msg);
            if (data.status == 0) {
                $('#first-modal-store').modal('hide');
            }
        }, 'json');
    });

    /* Second
    -----------------------------------------*/
    $("#second-edit form").submit(function(){
        $("button").attr("disabled","true");

        var id = $("input[type='hidden'][name='id']").val();
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
                if (!id) {
                    setTimeout(function(){location.href = $base + "second/edit/" + data.id;}, 1000);
                }
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
            }
            $("html, body").animate({scrollTop: 0}, 200);
            $("button").removeAttr("disabled");
        }, "json");
        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });
    // Modal category
    $('#second-index-content .edit-category').click(function(){
        var id = $(this).attr('data-id');
        $.get($base + 'second/category/' + id, function(data){
            if (data.status == 0) {
                $('#second-modal-category [name="id"]').val(id);
                $('#second-modal-category [name="flc-oid"]').val(data.data.first);
                $('#second-modal-category').modal({'backdrop': 'static', 'show': true});
            }
        }, 'json');
        return false;
    });
    $('#second-modal-category .save').click(function(){
        var id = $('#second-modal-category [name="id"]').val();
        var first = $('#second-modal-category select[name="flc-oid"]').val();
        $.post($base + 'second/savecategory/', {id: id, first: first}, function(data) {
            alert(data.msg);
            if (data.status == 0) {
                $('#second-modal-category').modal('hide');
            }
        }, 'json');
    });

    /* Dish
    -----------------------------------------*/
    $("#dish-edit form").submit(function(){
        $("button").attr("disabled","true");

        var id = $("input[type='hidden'][name='id']").val();
        var data = _.filter($(this).serializeArray(), function(item){ return ('store-oid' != item.name); });
        $(this).find('[name="store-oid"]').each(function() {
            if ($(this).is(':checked')) {
                data.push({name: 'store-oid[]', value: $(this).val()});
            }
        });
        $.post($(this).attr("action"), data, function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
                if (!id) {
                    setTimeout(function(){location.href = $base + "dish/edit/" + data.id;}, 1000);
                }
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
            }
            $("html, body").animate({scrollTop: 0}, 200);
            $("button").removeAttr("disabled");
        }, "json");
        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });
    $('#dish-index select[name="flc-oid"], #dish-modal-category select[name="flc-oid"]').change(function(){
        $t = $(this);
        $.get($base + 'dish/second/' + $(this).val(), function(data){
            var s = $t.parent().find('select[name="slc-oid"]');
            var hf = $t.parent().find('input[name="slc-oid"]');
            s.empty();
            hf.val('');
            if (data.status == 0) {
                $.each(data.data, function(key, val){
                    if (hf.val() == key) {
                        s.append($('<option>').text(val).val(key).attr('selected', true));
                    } else {
                        s.append($('<option>').text(val).val(key));
                    }
                });
            }
        }, "json");
    });
    $('#dish-index select[name="flc-oid"]').trigger('change');
    // Modal store
    $('#dish-index-content .edit-store').click(function(){
        var id = $(this).attr('data-id');
        $.get($base + 'dish/store/' + id, function(data){
            if (data.status == 0) {
                $('#dish-modal-store [name="store-oid"]').each(function(){
                    if (_.indexOf(data.data, $(this).val()) != -1) {
                        $(this).attr('checked', true);
                    } else {
                        $(this).removeAttr('checked');
                    }
                });
                $('#dish-modal-store [name="id"]').val(id);
                $('#dish-modal-store').modal({'backdrop': 'static', 'show': true});
            }
        }, 'json');
        return false;
    });
    $('#dish-modal-store .save').click(function(){
        var id = $('#dish-modal-store [name="id"]').val();
        var store = [];
        $('#dish-modal-store [name="store-oid"]').each(function(){
            if ($(this).is(':checked')) {
                store.push($(this).val());
            }
        });
        $.post($base + 'dish/savestore/', {id: id, store: store}, function(data) {
            alert(data.msg);
            if (data.status == 0) {
                $('#dish-modal-store').modal('hide');
            }
        }, 'json');
    });
    // Modal category
    $('#dish-index-content .edit-category').click(function(){
        var id = $(this).attr('data-id');
        $.get($base + 'dish/category/' + id, function(data){
            if (data.status == 0) {
                $('#dish-modal-category [name="flc-oid"]').val(data.data.first).trigger('change');
                $('#dish-modal-category [name="slc-oid"]').val(data.data.second);
                $('#dish-modal-category [name="id"]').val(id);
                $('#dish-modal-category').modal({'backdrop': 'static', 'show': true});
            }
        }, 'json');
        return false;
    });
    $('#dish-modal-category .save').click(function(){
        var id = $('#dish-modal-category [name="id"]').val();
        var first = $('#dish-modal-category select[name="flc-oid"]').val();
        var second = $('#dish-modal-category select[name="slc-oid"]').val();
        $.post($base + 'dish/savecategory/', {id: id, first: first, second: second}, function(data) {
            alert(data.msg);
            if (data.status == 0) {
                $('#dish-modal-category').modal('hide');
            }
        }, 'json');
    });

    $('#dish-image-edit form').submit(function() {
        $("button").attr("disabled","true");

        var data = [];
        $('#dish-image-edit form div.thumbnail img').each(function(){
            data.push({name: 'image[]', value: $(this).attr('data-ori') + '~' + $(this).attr('data-name')});
        });
        $('#dish-image-edit form div.thumbnail input[name="title[]"]').each(function(){
            data.push({name: 'title[]', value: $(this).val()});
        });
        $('#dish-image-edit form div.thumbnail textarea[name="desc[]"]').each(function(){
            data.push({name: 'desc[]', value: $(this).val()});
        });
        $('#dish-image-edit form div.thumbnail input[name="dflt[]"]').each(function(){
            data.push({name: 'dflt[]', value: ($(this).is(':checked') ? 1: 0)});
        });
        $('#dish-image-edit form div.thumbnail input[name="disp[]"]').each(function(){
            data.push({name: 'disp[]', value: ($(this).is(':checked') ? 1: 0)});
        });
        $.post($(this).attr("action"), data, function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
                setTimeout(function(){location.href = $base + "dish/image/" + data.id;}, 1000);
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
            }
            $("html, body").animate({scrollTop: 0}, 200);
            $("button").removeAttr("disabled");
        }, "json");
        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });
    if (typeof dish_image != 'undefined') {
        $.each(dish_image, function(key, data){
            li = _.template($('#dish-image-edit #image-tpl').html(), {image: data});
            $('#dish-image-edit ul.thumbnails li:last').before(li);
        });
    }
    $('#dish-image-edit div.del span').click(function(){
        if (confirm('是否需要删除？')) {
            $(this).parent().parent().parent().remove();
        }
    });
    $('#dish-image-edit #upload').click(function() {
        $.maupload.config({file:'#upload', modal: false});
        $.maupload.run(function(data){
            li = _.template($('#dish-image-edit #image-tpl').html(), {image: data});
            $('#dish-image-edit ul.thumbnails li:last').before(li).prev().find('div.del span').click(function(){
                $(this).parent().parent().parent().remove();
            });

        });
    });

    /* Ctrl param
    -----------------------------------------*/
    $("#param-edit form").submit(function(){
        $("button").attr("disabled","true");

        var id = $("input[type='hidden'][name='id']").val();
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
                if (!id) {
                    setTimeout(function(){location.href = $base + "param/edit/" + data.id;}, 1000);
                }
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
            }
            $("html, body").animate({scrollTop: 0}, 200);
            $("button").removeAttr("disabled");
        }, "json");
        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });

});

