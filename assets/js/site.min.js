jQuery(document).ready(function($){
    /* Common setting
    --------------------------------*/
    $(document).ajaxStart(function(){
        $("button").attr("disabled","true");
    });
    $(document).ajaxStop(function(){
        $("button").removeAttr("disabled");
    });
    if (navigator.userAgent.match(/msie [6]/i)) {
        $("#logo").before('<div class="alert text-center"><strong>注意: </strong>为了获得更好的使用体验，请使用<a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" target="_blank">IE7及其以上版本</a>，最佳体验使用IE9，<a href="http://www.google.com/chrome/" target="_blank">谷歌</a>，<a href="http://firefox.com.cn/" target="_blank">火狐</a>等浏览器。</div>');
    }

    var url = $("#baseurl").val();
    (function () {
        var $backToTopEle = jQuery('<div class="backtop"><a href="javascript:;" title="返回页面顶部"></a></div>').appendTo(jQuery("body"));

        jQuery('.backtop').click(function () {
            jQuery("html, body").animate({ scrollTop: 0 }, 200);
        });

        var _w = (jQuery(window).width() - 980) / 2 - 140;

        $backToTopFun = function () {
            var st = jQuery(document).scrollTop(),
            winh = jQuery(window).height();
            $backToTopEle.css("right", _w);
            (st > 100) ? $backToTopEle.fadeIn() : $backToTopEle.fadeOut();
            // For IE6
            if (!window.XMLHttpRequest) {
                $backToTopEle.css("top", st + winh - 100);
            }
        };
        jQuery(window).bind("scroll", $backToTopFun);
        $backToTopFun();
    })();
    $("form.s div.block label.tip").click(function (){
        $(this).hide();
        $(this).prev().focus();
    });
    $("form.s div.block input").focus(function () {
        $(this).next().hide();
    }).blur(function () {
        if ($(this).val() == "") $(this).next().show();
    });

    $('#myTab a').click(function (e) {
        e.preventDefault();
        $(this).tab('show');
    });

    /* Login
    --------------------------------*/
    $("#login div.block label.tip").click(function (){
        $(this).hide();
        $(this).prev().focus();
    });
    $("#login div.block input").focus(function () {
        $(this).next().hide();
    }).blur(function () {
        if ($(this).val() == "") $(this).next().show();
    });

    $("#login #p-captcha>*").click(function(){
        var src = $("#login #image-captcha").attr("src").split("?")[0];
        $("#login #image-captcha").attr("src", src + "?n=" + (new Date().valueOf()));
    });
    $("#login form").submit(function(){
        $("button").attr("disabled","true");
        $.post(url + "/login/validate/", $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                //location.replace(data.url ? data.url : url);
                location.href = data.url || url;
            } else {
                $("#login #p-captcha>img").trigger("click");
                $("#login input[name='captcha']").val("");
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                // Load capacha
                if ($('#login #p-captcha').length == 0) {
                    $('#login form input[name="pwd"]').parent().after('<p class="help-block" id="p-captcha">'+
                            '<img src="'+ url +'/captcha/?t='+ (new Date()).toString() +'" id="image-captcha"/><span class="btn btn-link" id="span-captcha" >看不清，换一张</span>'+
                        '</p>'+
                        '<div class="block">'+
                            '<input type="text" class="input-block-level" name="captcha" autocomplete="off">'+
                            '<label class="tip">验证码</label>'+
                        '</div>');

                    $("#login div.block label.tip").click(function (){
                        $(this).hide();
                        $(this).prev().focus();
                    });
                    $("#login div.block input").focus(function () {
                        $(this).next().hide();
                    }).blur(function () {
                        if ($(this).val() == "") $(this).next().show();
                    });
                    $("#login #p-captcha>*").click(function(){
                        var src = $("#login #image-captcha").attr("src").split("?")[0];
                        $("#login #image-captcha").attr("src", src + "?n=" + (new Date().valueOf()));
                    });

                }
            }
            $("button").removeAttr("disabled");
        }, "json");

        return false;
    });

    /* Probook
    --------------------------------*/
    $("#prebook-form").submit(function(){
        $that = $(this);
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                setTimeout(function(){
                    $that.get(0).reset();
                    $("#msg").removeClass("alert in").text("");
                }, 3000);
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                $("button").removeAttr("disabled");
            }
        }, "json");

        return false;
    });
});

