jQuery(document).ready(function($){
    /* Common setting
    --------------------------------*/
    $(document).ajaxStart(function(){
        $("button").attr("disabled","true");
    });
    $(document).ajaxStop(function(){
        $("button").removeAttr("disabled");
    });
    if (navigator.userAgent.match(/msie [6]/i)) {
        $("#logo").before('<div class="alert text-center"><strong>注意: </strong>为了获得更好的使用体验，请使用<a href="http://windows.microsoft.com/zh-cn/internet-explorer/download-ie" target="_blank">IE7及其以上版本</a>，最佳体验使用IE9，<a href="http://www.google.com/chrome/" target="_blank">谷歌</a>，<a href="http://firefox.com.cn/" target="_blank">火狐</a>等浏览器。</div>');
    }

    var $base = $("#baseurl").val();
    (function () {
        var $backToTopEle = jQuery('<div class="backtop"><a href="javascript:;" title="返回页面顶部"></a></div>').appendTo(jQuery("body"));

        jQuery('.backtop').click(function () {
            jQuery("html, body").animate({ scrollTop: 0 }, 200);
        });

        var _w = (jQuery(window).width() - 980) / 2 - 140;

        $backToTopFun = function () {
            var st = jQuery(document).scrollTop(),
            winh = jQuery(window).height();
            $backToTopEle.css("right", _w);
            (st > 100) ? $backToTopEle.fadeIn() : $backToTopEle.fadeOut();
            // For IE6
            if (!window.XMLHttpRequest) {
                $backToTopEle.css("top", st + winh - 100);
            }
        };
        jQuery(window).bind("scroll", $backToTopFun);
        $backToTopFun();
    })();
    $("div.block label.tip").click(function (){
        $(this).hide();
        $(this).prev().focus();
    });
    $("div.block input").focus(function () {
        $(this).next().hide();
    }).blur(function () {
        if ($(this).val() == "") $(this).next().show();
    });

    /* Login
    --------------------------------*/
    $("#login #p-captcha>*").click(function(){
        var src = $("#login #image-captcha").attr("src").split("?")[0];
        $("#login #image-captcha").attr("src", src + "?n=" + (new Date().valueOf()));
    });
    $("#login form").submit(function(){
        $("button").attr("disabled","true");
        $.post($base + "/login/validate/", $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                //location.replace(data.url ? data.url : url);
                location.href = data.url || $base;
            } else {
                $("#login #p-captcha>img").trigger("click");
                $("#login input[name='captcha']").val("");
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                // Load capacha
                if ($('#login #p-captcha').length == 0) {
                    $('#login form input[name="pwd"]').parent().after('<p class="help-block" id="p-captcha">'+
                            '<img src="'+ $base +'/captcha/?t='+ (new Date()).toString() +'" id="image-captcha"/><span class="btn btn-link" id="span-captcha" >看不清，换一张</span>'+
                        '</p>'+
                        '<div class="block">'+
                            '<input type="text" class="input-block-level" name="captcha" autocomplete="off">'+
                            '<label class="tip">验证码</label>'+
                        '</div>');

                    $("#login div.block label.tip").click(function (){
                        $(this).hide();
                        $(this).prev().focus();
                    });
                    $("#login div.block input").focus(function () {
                        $(this).next().hide();
                    }).blur(function () {
                        if ($(this).val() == "") $(this).next().show();
                    });
                    $("#login #p-captcha>*").click(function(){
                        var src = $("#login #image-captcha").attr("src").split("?")[0];
                        $("#login #image-captcha").attr("src", src + "?n=" + (new Date().valueOf()));
                    });

                }
            }
            $("button").removeAttr("disabled");
        }, "json");

        return false;
    });

    $(document).ajaxStart(function(){
        if ($('#ajax-message').length == 0) {
            $('<div id="ajax-message">Loading...</div>').css({
                position:'fixed', 
                top:10, 
                right:120, 
                width:120, 
                'z-index':2000, 
                'font-weight':'blod',
                color:'#de568d'
            }).appendTo($('body'));
        }
        $('#ajax-message').show();
    });
    $(document).ajaxStop(function(){
        $('#ajax-message').hide(800);
    });
    $(document).ajaxError();

    /* Home
    --------------------------------*/
    $("#home-index").submit(function(){
        $that = $(this);
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                setTimeout(function(){
                    $that.get(0).reset();
                    $("#msg").removeClass("alert in").text("");
                }, 3000);
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").text(data.msg);
                $("#msg").alert();
                $("button").removeAttr("disabled");
            }
        }, "json");

        return false;
    });

    $("#home-index").find('button[name="add"]').click(function(){
        location.href = $base + '/home/edit';
    });
    $("#home-index").find('button[name="edit"]').click(function(){
        var c = $('#home-index').find('select[name="company"]');
        if (!c.val()) {
           alert('请选择公司'); 
           return false;
        }
        location.href = $base + '/home/edit/' + c.val();
    });
    $("#home-index").find('button[name="entry"]').click(function(){
        var c = $('#home-index').find('select[name="company"]');
        if (!c.val()) {
           alert('请选择公司'); 
           return false;
        }
        location.href = $base + '/home/entry/' + c.val();
    });
    $("#home-index").find('button[name="del"]').click(function(){
        var c = $('#home-index').find('select[name="company"]');
        if (!c.val()) {
           alert('请选择公司'); 
           return false;
        }
        if (confirm('确定要删除该公司?')) {
            $.post($base + '/home/del/' + c.val(), function(data){
                if (data.status == 0) {
                    $("#msg").attr("class","alert fade in");
                    $("#msg").html(data.msg);
                    $("#msg").alert();
                    if (!id) {
                        setTimeout(function(){location.href = $base + "/home";}, 1000);
                    }
                } else {
                    $("#msg").attr("class","alert alert-block alert-error fade in");
                    $("#msg").html(data.msg);
                    $("#msg").alert();
                }
                $("button").removeAttr("disabled");
            }, "json");
        }
    });

    /* User
    -----------------------------------------*/
    $("#user-edit form").submit(function(){
        $("button").attr("disabled","true");

        var id = $("input[type='hidden'][name='id']").val();
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
                if (!id) {
                    setTimeout(function(){location.href = $base + "/user/edit/" + data.id;}, 1000);
                }
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
            }
            $("html, body").animate({scrollTop: 0}, 200);
            $("button").removeAttr("disabled");
        }, "json");
        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });

    $('#user-edit').find('#reset-pwd-modal').on('show', function(){
        $('input[name="login-pwd"]').val('');
        $('input[name="login-pwd2"]').val('');
        $("#modal-msg").removeClass('alert').html("");
    });
    $("#user-edit").find('button[name="reset-pwd"]').click(function(){
        var id = $("input[type='hidden'][name='id']").val();
        var pwd = $.trim($('input[name="login-pwd"]').val());
        var pwd2 = $.trim($('input[name="login-pwd2"]').val());
        if (pwd.length == 0 || pwd2.length == 0) {
            $("#modal-msg").addClass("alert fade in");
            $("#modal-msg").html('请输入密码');
            $("#modal-msg").alert();
            return false;
        }

        if (pwd != pwd2) {
            $("#modal-msg").addClass("alert fade in");
            $("#modal-msg").html('密码不一致');
            $("#modal-msg").alert();
            return false;
        }

        $("button").attr("disabled","true");
        $("#modal-msg").removeClass('alert').html("");
        $.post($base + '/user/reset', {id: id, pwd: pwd}, function(data){
            if (data.status == 0) {
                $("#modal-msg").attr("class","alert fade in");
                $("#modal-msg").html(data.msg);
                $("#modal-msg").alert();
                setTimeout(function(){$('#reset-pwd-modal').modal('hide');}, 2000);
            } else {
                $("#modal-msg").attr("class","alert alert-block alert-error fade in");
                $("#modal-msg").html(data.msg);
                $("#modal-msg").alert();
            }
            $("button").removeAttr("disabled");
        }, "json");
    });

    /* Store
    -----------------------------------------*/
    $("#store-edit form").submit(function(){
        $("button").attr("disabled","true");

        var id = $("input[type='hidden'][name='id']").val();
        $.post($(this).attr("action"), $(this).serialize(), function(data){
            if (data.status == 0) {
                $("#msg").attr("class","alert fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
                if (!id) {
                    setTimeout(function(){location.href = $base + "/store/edit/" + data.id;}, 1000);
                }
            } else {
                $("#msg").attr("class","alert alert-block alert-error fade in");
                $("#msg").html(data.msg);
                $("#msg").alert();
            }
            $("html, body").animate({scrollTop: 0}, 200);
            $("button").removeAttr("disabled");
        }, "json");
        return false;
    }).keydown(function(e) {
        if (e.keyCode==13) {
            e.keyCode = 9;
        }
    });

});

